<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.xoa.dao.sms.SmsMapper">
    <resultMap id="BaseResultMap" type="com.xoa.model.sms.Sms">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        <result column="SMS_ID" property="smsId" jdbcType="INTEGER"/>
        <result column="TO_ID" property="toId" jdbcType="VARCHAR"/>
        <result column="REMIND_FLAG" property="remindFlag" jdbcType="CHAR"/>
        <result column="DELETE_FLAG" property="deleteFlag" jdbcType="CHAR"/>
        <result column="BODY_ID" property="bodyId" jdbcType="INTEGER"/>
        <result column="REMIND_TIME" property="remindTime" jdbcType="INTEGER"/>
    </resultMap>
    <sql id="Example_Where_Clause">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        <where>
            <foreach collection="oredCriteria" item="criteria" separator="or">
                <if test="criteria.valid">
                    <trim prefix="(" suffix=")" prefixOverrides="and">
                        <foreach collection="criteria.criteria" item="criterion">
                            <choose>
                                <when test="criterion.noValue">
                                    and ${criterion.condition}
                                </when>
                                <when test="criterion.singleValue">
                                    and ${criterion.condition} #{criterion.value}
                                </when>
                                <when test="criterion.betweenValue">
                                    and ${criterion.condition} #{criterion.value} and #{criterion.secondValue}
                                </when>
                                <when test="criterion.listValue">
                                    and ${criterion.condition}
                                    <foreach collection="criterion.value" item="listItem" open="(" close=")"
                                             separator=",">
                                        #{listItem}
                                    </foreach>
                                </when>
                            </choose>
                        </foreach>
                    </trim>
                </if>
            </foreach>
        </where>
    </sql>
    <sql id="Update_By_Example_Where_Clause">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        <where>
            <foreach collection="example.oredCriteria" item="criteria" separator="or">
                <if test="criteria.valid">
                    <trim prefix="(" suffix=")" prefixOverrides="and">
                        <foreach collection="criteria.criteria" item="criterion">
                            <choose>
                                <when test="criterion.noValue">
                                    and ${criterion.condition}
                                </when>
                                <when test="criterion.singleValue">
                                    and ${criterion.condition} #{criterion.value}
                                </when>
                                <when test="criterion.betweenValue">
                                    and ${criterion.condition} #{criterion.value} and #{criterion.secondValue}
                                </when>
                                <when test="criterion.listValue">
                                    and ${criterion.condition}
                                    <foreach collection="criterion.value" item="listItem" open="(" close=")"
                                             separator=",">
                                        #{listItem}
                                    </foreach>
                                </when>
                            </choose>
                        </foreach>
                    </trim>
                </if>
            </foreach>
        </where>
    </sql>
    <sql id="Base_Column_List">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        SMS_ID, TO_ID, REMIND_FLAG, DELETE_FLAG, BODY_ID, REMIND_TIME
    </sql>
    <select id="selectByExample" resultMap="BaseResultMap" parameterType="com.xoa.model.sms.SmsExample">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        select
        <if test="distinct">
            distinct
        </if>
        <include refid="Base_Column_List"/>
        from sms
        <if test="_parameter != null">
            <include refid="Example_Where_Clause"/>
        </if>
        <if test="orderByClause != null">
            order by ${orderByClause}
        </if>
    </select>
    <delete id="deleteByExample" parameterType="com.xoa.model.sms.SmsExample">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        delete from sms
        <if test="_parameter != null">
            <include refid="Example_Where_Clause"/>
        </if>
    </delete>
    <insert id="insert" parameterType="com.xoa.model.sms.Sms">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        insert into sms (SMS_ID, TO_ID, REMIND_FLAG,
        DELETE_FLAG, BODY_ID, REMIND_TIME
        )
        values (#{smsId,jdbcType=INTEGER}, #{toId,jdbcType=VARCHAR}, #{remindFlag,jdbcType=CHAR},
        #{deleteFlag,jdbcType=CHAR}, #{bodyId,jdbcType=INTEGER}, #{remindTime,jdbcType=INTEGER}
        )
    </insert>
    <insert id="insertSelective" parameterType="com.xoa.model.sms.Sms">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        insert into sms
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="smsId != null">
                SMS_ID,
            </if>
            <if test="toId != null">
                TO_ID,
            </if>
            <if test="remindFlag != null">
                REMIND_FLAG,
            </if>
            <if test="deleteFlag != null">
                DELETE_FLAG,
            </if>
            <if test="bodyId != null">
                BODY_ID,
            </if>
            <if test="remindTime != null">
                REMIND_TIME,
            </if>
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="smsId != null">
                #{smsId,jdbcType=INTEGER},
            </if>
            <if test="toId != null">
                #{toId,jdbcType=VARCHAR},
            </if>
            <if test="remindFlag != null">
                #{remindFlag,jdbcType=CHAR},
            </if>
            <if test="deleteFlag != null">
                #{deleteFlag,jdbcType=CHAR},
            </if>
            <if test="bodyId != null">
                #{bodyId,jdbcType=INTEGER},
            </if>
            <if test="remindTime != null">
                #{remindTime,jdbcType=INTEGER},
            </if>
        </trim>
    </insert>
    <select id="countByExample" parameterType="com.xoa.model.sms.SmsExample" resultType="java.lang.Integer">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        select count(*) from sms
        <if test="_parameter != null">
            <include refid="Example_Where_Clause"/>
        </if>
    </select>
    <update id="updateByExampleSelective" parameterType="map">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        update sms
        <set>
            <if test="record.smsId != null">
                SMS_ID = #{record.smsId,jdbcType=INTEGER},
            </if>
            <if test="record.toId != null">
                TO_ID = #{record.toId,jdbcType=VARCHAR},
            </if>
            <if test="record.remindFlag != null">
                REMIND_FLAG = #{record.remindFlag,jdbcType=CHAR},
            </if>
            <if test="record.deleteFlag != null">
                DELETE_FLAG = #{record.deleteFlag,jdbcType=CHAR},
            </if>
            <if test="record.bodyId != null">
                BODY_ID = #{record.bodyId,jdbcType=INTEGER},
            </if>
            <if test="record.remindTime != null">
                REMIND_TIME = #{record.remindTime,jdbcType=INTEGER},
            </if>
        </set>
        <if test="_parameter != null">
            <include refid="Update_By_Example_Where_Clause"/>
        </if>
    </update>
    <update id="updateByExample" parameterType="map">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        update sms
        set SMS_ID = #{record.smsId,jdbcType=INTEGER},
        TO_ID = #{record.toId,jdbcType=VARCHAR},
        REMIND_FLAG = #{record.remindFlag,jdbcType=CHAR},
        DELETE_FLAG = #{record.deleteFlag,jdbcType=CHAR},
        BODY_ID = #{record.bodyId,jdbcType=INTEGER},
        REMIND_TIME = #{record.remindTime,jdbcType=INTEGER}
        <if test="_parameter != null">
            <include refid="Update_By_Example_Where_Clause"/>
        </if>
    </update>


    <select id="getSmsByMap" resultMap="BaseResultMap" parameterType="map">
        select s.*,sb.* from sms s, sms_body sb
        WHERE s.body_id=sb.body_id
        <if test=" #{remindFlag}!=null and #{remindFlag} !='' ">
            and s.REMIND_FLAG = #{remindFlag}
        </if>
        <if test=" #{toId}!=null and #{toId}!='' ">
            and s.TO_ID = #{toId}
        </if>
        <if test="#{fromId}!=null and #{fromId}!='' ">
            and sb.from_id = #{fromId}
        </if>
    </select>

    <update id="updateDeleteFlag">
        update sms SET delete_flag = #{deleteFlag} where 1 = 1
        <if test=" deleteFlag == 1 ">
            and to_id = #{toId}
        </if>
        <if test="bodyIds!=null">
            and body_id in
            <foreach item="bodyId" collection="bodyIds" open="(" separator="," close=")">
                #{bodyId}
            </foreach>
        </if>
    </update>

    <update id="deleteByRemind">
        update sms s,sms_Body sb SET s.delete_flag = 1 where
        <if test="toId!=null">
            s.to_id = #{toId}
        </if>
        <if test="fromId!=null">
            sb.from_id = #{fromId}
        </if>
        and s.remind_Flag = 0 ;
    </update>

    <update id="deleteByDelFlag">
        update sms s,sms_body sb SET s.delete_flag = 2 where s.body_id = sb.body_id and  sb.from_id = #{fromId} and s.delete_flag = 1 ;
    </update>

    <update id="updateRemindFlag">
        update sms SET REMIND_FLAG = #{remindFlag} where to_id = #{toId}
        <if test="bodyIds!=null ">
            and body_id in
            <foreach item="bodyId" collection="bodyIds" open="(" separator="," close=")">
                #{bodyId}
            </foreach>
        </if>
    </update>

    <update id="setRead">
         update sms SET REMIND_FLAG = 0 where to_id = #{toId} and body_id = #{bodyId}
    </update>

    <update id="setReadByUrl" >
        update sms s, sms_body sb SET s.REMIND_FLAG = 0 where s.body_id = sb.body_id and  to_id = #{toId} and sb.remind_url like concat('%', #{url}, '%')
    </update>

</mapper>