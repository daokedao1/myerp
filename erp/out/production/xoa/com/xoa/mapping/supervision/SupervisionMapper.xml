<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.xoa.dao.supervision.SupervisionMapper" >
  <resultMap id="BaseResultMap" type="com.xoa.model.supervision.Supervision" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    <id column="sid" property="sid" javaType="INTEGER" />
    <result column="sup_name" property="supName" javaType="String" />
    <result column="type_id" property="typeId" jdbcType="INTEGER" />
    <result column="leader_id" property="leaderId" />
    <result column="manager_id" property="managerId" />
    <result column="end_time" property="endTime" jdbcType="TIMESTAMP" />
    <result column="begin_time" property="beginTime" jdbcType="TIMESTAMP" />
    <result column="content" property="content" jdbcType="VARCHAR" />
    <result column="creater_id" property="createrId"  />
    <result column="creater_time" property="createrTime" jdbcType="TIMESTAMP" />
    <result column="status" property="status" jdbcType="INTEGER" />
    <result column="parent_id" property="parentId" jdbcType="INTEGER" />
    <result column="real_end_time" property="realEndTime" jdbcType="TIMESTAMP" />
  </resultMap>

  <resultMap id="UserResultMap" type="com.xoa.model.supervision.Supervision" extends="BaseResultMap">
    <result column="UID" property="uid" jdbcType="INTEGER" />
    <result column="USER_ID" property="userId"  />
    <result column="USER_NAME" property="userName" jdbcType="VARCHAR" />
    <result column="USER_PRIV_NAME" property="userPrivName" jdbcType="VARCHAR" />
    <result column="DEPT_NAME" property="deptName" jdbcType="VARCHAR" />
    <result column="DEPT_ID" property="deptId" jdbcType="INTEGER" />
    <result column="type_name" property="typeName" jdbcType="VARCHAR" />
    <result column="manager_Name" property="managerName" jdbcType="VARCHAR" />
     <result column="count0" property="count0"/>
      <result column="count1" property="count1"/>
       <result column="count2" property="count2"/>
        <result column="count3" property="count3"/>
         <result column="count4" property="count4"/>
          <result column="count5" property="count5"/>
           <result column="count6" property="count6"/>
  </resultMap>

  <sql id="Example_Where_Clause" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    <where >
      <foreach collection="oredCriteria" item="criteria" separator="or" >
        <if test="criteria.valid" >
          <trim prefix="(" suffix=")" prefixOverrides="and" >
            <foreach collection="criteria.criteria" item="criterion" >
              <choose >
                <when test="criterion.noValue" >
                  and ${criterion.condition}
                </when>
                <when test="criterion.singleValue" >
                  and ${criterion.condition} #{criterion.value}
                </when>
                <when test="criterion.betweenValue" >
                  and ${criterion.condition} #{criterion.value} and #{criterion.secondValue}
                </when>
                <when test="criterion.listValue" >
                  and ${criterion.condition}
                  <foreach collection="criterion.value" item="listItem" open="(" close=")" separator="," >
                    #{listItem}
                  </foreach>
                </when>
              </choose>
            </foreach>
          </trim>
        </if>
      </foreach>
    </where>
  </sql>
  <sql id="Update_By_Example_Where_Clause" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    <where >
      <foreach collection="example.oredCriteria" item="criteria" separator="or" >
        <if test="criteria.valid" >
          <trim prefix="(" suffix=")" prefixOverrides="and" >
            <foreach collection="criteria.criteria" item="criterion" >
              <choose >
                <when test="criterion.noValue" >
                  and ${criterion.condition}
                </when>
                <when test="criterion.singleValue" >
                  and ${criterion.condition} #{criterion.value}
                </when>
                <when test="criterion.betweenValue" >
                  and ${criterion.condition} #{criterion.value} and #{criterion.secondValue}
                </when>
                <when test="criterion.listValue" >
                  and ${criterion.condition}
                  <foreach collection="criterion.value" item="listItem" open="(" close=")" separator="," >
                    #{listItem}
                  </foreach>
                </when>
              </choose>
            </foreach>
          </trim>
        </if>
      </foreach>
    </where>
  </sql>
  <sql id="Base_Column_List" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    sid, sup_name, type_id, leader_id, manager_id, end_time, begin_time, content, creater_id,
    creater_time, status, parent_id, real_end_time
  </sql>
  <select id="selectByExample" resultMap="BaseResultMap" parameterType="com.xoa.model.supervision.SupervisionExample" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    select
    <if test="distinct" >
      distinct
    </if>
    <include refid="Base_Column_List" />
    from supervision
    <if test="_parameter != null" >
      <include refid="Example_Where_Clause" />
    </if>
    <if test="orderByClause != null" >
      order by ${orderByClause}
    </if>
  </select>
  <select id="selectByPrimaryKey" resultMap="BaseResultMap" parameterType="java.lang.Integer" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    select
    <include refid="Base_Column_List" />
    from supervision
    where sid = #{sid,jdbcType=INTEGER}
  </select>
  <delete id="deleteByPrimaryKey" parameterType="java.lang.Integer" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    delete from supervision
    where sid = #{sid,jdbcType=INTEGER}
  </delete>
  <delete id="deleteByExample" parameterType="com.xoa.model.supervision.SupervisionExample" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    delete from supervision
    <if test="_parameter != null" >
      <include refid="Example_Where_Clause" />
    </if>
  </delete>
  <insert id="insert" parameterType="com.xoa.model.supervision.Supervision" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    insert into supervision (sid, sup_name, type_id,
    leader_id, manager_id, end_time,
    begin_time, content, creater_id,
    creater_time, status, parent_id,
    real_end_time)
    values (#{sid,jdbcType=INTEGER}, #{supName,jdbcType=VARCHAR}, #{typeId,jdbcType=INTEGER},
    #{leaderId,jdbcType=INTEGER}, #{managerId,jdbcType=INTEGER}, #{endTime,jdbcType=TIMESTAMP},
    #{beginTime,jdbcType=TIMESTAMP}, #{content,jdbcType=VARCHAR}, #{createrId,jdbcType=INTEGER},
    #{createrTime,jdbcType=TIMESTAMP}, #{status,jdbcType=INTEGER}, #{parentId,jdbcType=INTEGER},
    #{realEndTime,jdbcType=TIMESTAMP})
  </insert>
  <insert id="insertSelective" parameterType="com.xoa.model.supervision.Supervision" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    insert into supervision
    <trim prefix="(" suffix=")" suffixOverrides="," >
      <if test="sid != null" >
        sid,
      </if>
      <if test="supName != null" >
        sup_name,
      </if>
      <if test="typeId != null" >
        type_id,
      </if>
      <if test="leaderId != null" >
        leader_id,
      </if>
      <if test="managerId != null" >
        manager_id,
      </if>
      <if test="endTime != null" >
        end_time,
      </if>
      <if test="beginTime != null" >
        begin_time,
      </if>
      <if test="content != null" >
        content,
      </if>
      <if test="createrId != null" >
        creater_id,
      </if>
      <if test="createrTime != null" >
        creater_time,
      </if>
      <if test="status != null" >
        status,
      </if>
      <if test="parentId != null" >
        parent_id,
      </if>
      <if test="realEndTime != null" >
        real_end_time,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides="," >
      <if test="sid != null" >
        #{sid,jdbcType=INTEGER},
      </if>
      <if test="supName != null" >
        #{supName,jdbcType=VARCHAR},
      </if>
      <if test="typeId != null" >
        #{typeId,jdbcType=INTEGER},
      </if>
      <if test="leaderId != null" >
        #{leaderId,jdbcType=INTEGER},
      </if>
      <if test="managerId != null" >
        #{managerId,jdbcType=INTEGER},
      </if>
      <if test="endTime != null" >
        #{endTime,jdbcType=TIMESTAMP},
      </if>
      <if test="beginTime != null" >
        #{beginTime,jdbcType=TIMESTAMP},
      </if>
      <if test="content != null" >
        #{content,jdbcType=VARCHAR},
      </if>
      <if test="createrId != null" >
        #{createrId,jdbcType=INTEGER},
      </if>
      <if test="createrTime != null" >
        #{createrTime,jdbcType=TIMESTAMP},
      </if>
      <if test="status != null" >
        #{status,jdbcType=INTEGER},
      </if>
      <if test="parentId != null" >
        #{parentId,jdbcType=INTEGER},
      </if>
      <if test="realEndTime != null" >
        #{realEndTime},
      </if>
    </trim>
  </insert>
  <select id="countByExample" parameterType="com.xoa.model.supervision.SupervisionExample" resultType="java.lang.Integer" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    select count(*) from supervision
    <if test="_parameter != null" >
      <include refid="Example_Where_Clause" />
    </if>
  </select>
  <update id="updateByExampleSelective" parameterType="map" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    update supervision
    <set >
      <if test="record.sid != null" >
        sid = #{record.sid,jdbcType=INTEGER},
      </if>
      <if test="record.supName != null" >
        sup_name = #{record.supName,jdbcType=VARCHAR},
      </if>
      <if test="record.typeId != null" >
        type_id = #{record.typeId,jdbcType=INTEGER},
      </if>
      <if test="record.leaderId != null" >
        leader_id = #{record.leaderId,jdbcType=INTEGER},
      </if>
      <if test="record.managerId != null" >
        manager_id = #{record.managerId,jdbcType=INTEGER},
      </if>
      <if test="record.endTime != null" >
        end_time = #{record.endTime,jdbcType=TIMESTAMP},
      </if>
      <if test="record.beginTime != null" >
        begin_time = #{record.beginTime,jdbcType=TIMESTAMP},
      </if>
      <if test="record.content != null" >
        content = #{record.content,jdbcType=VARCHAR},
      </if>
      <if test="record.createrId != null" >
        creater_id = #{record.createrId,jdbcType=INTEGER},
      </if>
      <if test="record.createrTime != null" >
        creater_time = #{record.createrTime,jdbcType=TIMESTAMP},
      </if>
      <if test="record.status != null" >
        status = #{record.status,jdbcType=INTEGER},
      </if>
      <if test="record.parentId != null" >
        parent_id = #{record.parentId,jdbcType=INTEGER},
      </if>
      <if test="record.realEndTime != null" >
        real_end_time = #{record.realEndTime,jdbcType=TIMESTAMP},
      </if>
    </set>
    <if test="_parameter != null" >
      <include refid="Update_By_Example_Where_Clause" />
    </if>
  </update>
  <update id="updateByExample" parameterType="map" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    update supervision
    set sid = #{record.sid,jdbcType=INTEGER},
    sup_name = #{record.supName,jdbcType=VARCHAR},
    type_id = #{record.typeId,jdbcType=INTEGER},
    leader_id = #{record.leaderId,jdbcType=INTEGER},
    manager_id = #{record.managerId,jdbcType=INTEGER},
    end_time = #{record.endTime,jdbcType=TIMESTAMP},
    begin_time = #{record.beginTime,jdbcType=TIMESTAMP},
    content = #{record.content,jdbcType=VARCHAR},
    creater_id = #{record.createrId,jdbcType=INTEGER},
    creater_time = #{record.createrTime,jdbcType=TIMESTAMP},
    status = #{record.status,jdbcType=INTEGER},
    parent_id = #{record.parentId,jdbcType=INTEGER},
    real_end_time = #{record.realEndTime,jdbcType=TIMESTAMP}
    <if test="_parameter != null" >
      <include refid="Update_By_Example_Where_Clause" />
    </if>
  </update>
  <update id="updateByPrimaryKeySelective" parameterType="com.xoa.model.supervision.Supervision" >
    update supervision
    <set >
      <if test="supName != null" >
        sup_name = #{supName,jdbcType=VARCHAR},
      </if>
      <if test="typeId != null" >
        type_id = #{typeId,jdbcType=INTEGER},
      </if>
      <if test="leaderId != null" >
        leader_id = #{leaderId,jdbcType=INTEGER},
      </if>
      <if test="managerId != null" >
        manager_id = #{managerId,jdbcType=INTEGER},
      </if>
      <if test="endTime != null" >
        end_time = #{endTime,jdbcType=TIMESTAMP},
      </if>
      <if test="beginTime != null" >
        begin_time = #{beginTime,jdbcType=TIMESTAMP},
      </if>
      <if test="content != null" >
        content = #{content,jdbcType=VARCHAR},
      </if>
      <if test="createrId != null" >
        creater_id = #{createrId,jdbcType=INTEGER},
      </if>
      <if test="createrTime != null" >
        creater_time = #{createrTime,jdbcType=TIMESTAMP},
      </if>
      <if test="status != null" >
        status = #{status},
      </if>
      <if test="parentId != null" >
        parent_id = #{parentId},
      </if>
      <if test="realEndTime != null" >
        real_end_time = #{realEndTime,jdbcType=TIMESTAMP},
      </if>
    </set>
    where sid = #{sid}
  </update>
  <update id="updateByPrimaryKey" parameterType="com.xoa.model.supervision.Supervision" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    update supervision
    set sup_name = #{supName,jdbcType=VARCHAR},
    type_id = #{typeId,jdbcType=INTEGER},
    leader_id = #{leaderId,jdbcType=INTEGER},
    manager_id = #{managerId,jdbcType=INTEGER},
    end_time = #{endTime,jdbcType=TIMESTAMP},
    begin_time = #{beginTime,jdbcType=TIMESTAMP},
    content = #{content,jdbcType=VARCHAR},
    creater_id = #{createrId,jdbcType=INTEGER},
    creater_time = #{createrTime,jdbcType=TIMESTAMP},
    status = #{status,jdbcType=INTEGER},
    parent_id = #{parentId,jdbcType=INTEGER},
    real_end_time = #{realEndTime,jdbcType=TIMESTAMP}
    where sid = #{sid,jdbcType=INTEGER}
  </update>

  <select id="getSupManageByTypeId" resultMap="UserResultMap" parameterType="Integer">
    SELECT
    s.sid,
    s.sup_name,
    u_c.USER_NAME as DEPT_NAME,
    u_l.USER_NAME  as USER_NAME,
    s.leader_id,
    s.manager_id,
    u_m.USER_NAME AS manager_Name,
    s.content,
    s.end_time,
    s.type_id,
    s.status,
    s.user_id,
    s.parent_id
    FROM
    supervision s
    LEFT JOIN `user` u_l ON s.leader_id = u_l.USER_ID
    LEFT JOIN `user` u_m ON s.manager_id = u_m.USER_ID
    LEFT JOIN `user` u_c ON s.creater_id = u_c.USER_ID
    WHERE
    s.type_id =#{typeId}
  </select>

 <!--  <trim prefix="(" suffix=")" suffixOverrides="," >
      <if test="supName != null and supName !=''" >
        sup_name,
      </if>
      <if test="typeId != null and typeId !=''" >
        type_id,
      </if>
      <if test="leaderId != null and leaderId !=''" >
        leader_id,
      </if>
      <if test="managerId != null and managerId !=''" >
        manager_id,
      </if>
      <if test="endTime != null and endTime !=''" >
        end_time,
      </if>
      <if test="beginTime != null and beginTime !=''" >
        begin_time,
      </if>
      <if test="content != null and content !=''" >
        content,
      </if>
      <if test="createrId != null and createrId !=''" >
        creater_id,
      </if>
      <if test="createrTime != null and createrTime !=''" >
        creater_time,
      </if>
      <if test="status != null and status !=''" >
        status,
      </if>
      <if test="parentId != null and parentId !=''" >
        parent_id,
      </if>
      <if test="realEndTime != null and realEndTime !=''" >
        real_end_time,
      </if>
    </trim> -->
  <insert id="addSupervision" parameterType="com.xoa.model.supervision.Supervision">
    <selectKey order="AFTER" keyProperty="sid" resultType="int">
      SELECT LAST_INSERT_ID()
    </selectKey>
    insert into supervision (
      sup_name ,
      type_id ,
      leader_id ,
      manager_id ,

    <if test="endTime != null" >
      end_time ,
    </if>
    <if test="beginTime != null" >
      begin_time ,
    </if>
      content ,
      creater_id ,
    <if test="createrTime != null" >
      creater_time ,
    </if>
      status ,
      parent_id ,
    <if test="realEndTime != null" >
      real_end_time ,
    </if>
      user_id
      )
    <trim prefix="values (" suffix=")" suffixOverrides="," >

      <if test="supName == null" >
        '',
      </if>
      <if test="supName != null" >
        #{supName},
      </if>

      <if test="typeId == null" >
        0,
      </if>
      <if test="typeId != null" >
        #{typeId},
      </if>

      <if test="leaderId == null" >
        '',
      </if>
      <if test="leaderId != null" >
        #{leaderId},
      </if>

      <if test="managerId == null" >
        '',
      </if>
      <if test="managerId != null" >
        #{managerId},
      </if>

      <if test="endTime != null" >
        #{endTime},
      </if>

      <if test="beginTime != null" >
        #{beginTime},
      </if>

      <if test="content == null" >
        '',
      </if>
      <if test="content != null" >
        #{content},
      </if>

      <if test="createrId == null" >
        0,
      </if>
      <if test="createrId != null" >
        #{createrId},
      </if>

      <if test="createrTime != null" >
        #{createrTime},
      </if>

      <if test="status == null" >
        0,
      </if>

      <if test="status != null" >
        #{status},
      </if>

      <if test="parentId == null" >
        0,
      </if>

      <if test="parentId != null" >
        #{parentId},
      </if>

      <if test="realEndTime != null" >
        #{realEndTime},
      </if>

      <if test="userId == null" >
        '',
      </if>
      <if test="userId != null" >
        #{userId}
      </if>
    </trim>
  </insert>

  <delete id="deleteSupervisionBySid" parameterType="Integer">
    DELETE FROM supervision WHERE sid=#{sid}
  </delete>
  <select id="selectCountList" parameterType="com.xoa.model.supervision.Supervision" resultMap="UserResultMap">
    SELECT
    d.DEPT_NAME,
    s.dept_id
    FROM
    department AS d INNER JOIN
    supervision AS s ON d.DEPT_ID=s.dept_id
    <where>
      <if test="status!=null and status!=''">
        and status=#{status}
      </if>
      <if test="beginTime!=null and beginTime=''">
        and begin_time= #{beginTime}
      </if>
      <if test="endTime!=null and endTime=''">
        and end_time= #{endTime}
      </if>
      <if test="typeId!=null and typeId!=''">
        and type_id=#{typeId}
      </if>
      <if test="deptId!=null and deptId!=''">
        and dept_Id=#{deptId}
      </if>
    </where>
  </select>

  <select id="getSupAssistDetail" resultMap="UserResultMap" parameterType="com.xoa.model.supervision.Supervision" >
    SELECT
    s.sid,
    s.sup_name,
    u_c.USER_NAME as  creater_id,
    u_l.USER_NAME AS DEPT_NAME,
    s.leader_id,
    s.manager_id,
    u_m.USER_NAME AS manager_Name,
    s.begin_time,
    s.end_time,
    s.content,
    s.parent_id,
    if (s.manager_id=#{managerId},1,0) as count0 ,
    if ((s.USER_ID LIKE concat('%,',#{managerId},',%') OR s.USER_ID LIKE concat(#{managerId},',%')),1,0) as count1 ,
    if (s.leader_id=#{managerId},1,0) as count2 ,
    s.user_id,
    s.type_id
    FROM
    supervision s
    LEFT JOIN `user` u_l ON s.leader_id = u_l.USER_ID
    LEFT JOIN `user` u_m ON s.manager_id = u_m.USER_ID
    LEFT JOIN `user` u_c ON s.creater_id = u_c.USER_ID
    WHERE
    s.sid=#{sid}
  </select>
<!--  <select id="queryCountSupervisionByStatus" resultMap="BaseResultMap" parameterType="com.xoa.model.supervision.Supervision">
    SELECT
    count(*)
    FROM
    supervision
    <where>
      <if test="status!=null and status!=''">
        and status=#{status}
      </if>
      <if test="beginTime!=null and beginTime=''">
        and begin_time= #{beginTime}
      </if>
      <if test="endTime!=null and endTime=''">
        and end_time= #{endTime}
      </if>
      <if test="typeId!=null and typeId!=''">
        and type_id=#{typeId}
      </if>
      <if test="deptId!=null and deptId!=''">
        and dept_Id=#{deptId}
      </if>
    </where>
  </select>-->
  <select id="queryCountSupervisionByStatus" parameterType="com.xoa.model.supervision.Supervision" resultMap="BaseResultMap">
 select (select count(sp.sid) from supervision sp,user u where sp.manager_id=u.USER_ID AND u.DEPT_ID=#{deptId} and sp.status=0
    <if test="typeId!=null and typeId!=''">
      and sp.type_id=#{typeId}
    </if>
    <if test="beginDate!=null and beginDate!='' and endDate!=null and endDate!=''">
      and sp.begin_time  BETWEEN #{beginDate}  AND  #{endDate}
    </if>
 ) as count0 ,
  (select count(sp.sid) from supervision sp,user u where sp.manager_id=u.USER_ID AND u.DEPT_ID=#{deptId} and sp.status=1
    <if test="typeId!=null and typeId!=''">
      and sp.type_id=#{typeId}
    </if>
    <if test="beginDate!=null and beginDate!='' and endDate!=null and endDate!=''">
      and sp.begin_time  BETWEEN #{beginDate}  AND  #{endDate}
    </if>) as count1 ,
  (select count(sp.sid) from supervision sp,user u where sp.manager_id=u.USER_ID AND u.DEPT_ID=#{deptId} and sp.status=2
    <if test="typeId!=null and typeId!=''">
      and sp.type_id=#{typeId}
    </if>
    <if test="beginDate!=null and beginDate!='' and endDate!=null and endDate!=''">
      and sp.begin_time  BETWEEN #{beginDate}  AND  #{endDate}
    </if>) as count2 ,
  (select count(sp.sid) from supervision sp,user u where sp.manager_id=u.USER_ID AND u.DEPT_ID=#{deptId} and sp.status=3
    <if test="typeId!=null and typeId!=''">
      and sp.type_id=#{typeId}
    </if>
    <if test="beginDate!=null and beginDate!='' and endDate!=null and endDate!=''">
      and sp.begin_time  BETWEEN #{beginDate}  AND  #{endDate}
    </if>) as count3 ,
  (select count(sp.sid) from supervision sp,user u where sp.manager_id=u.USER_ID AND u.DEPT_ID=#{deptId} and sp.status=4
    <if test="typeId!=null and typeId!=''">
      and sp.type_id=#{typeId}
    </if>
    <if test="beginDate!=null and beginDate!='' and endDate!=null and endDate!=''">
      and sp.begin_time  BETWEEN #{beginDate}  AND  #{endDate}
    </if>) as count4 ,
  (select count(sp.sid) from supervision sp,user u where sp.manager_id=u.USER_ID AND u.DEPT_ID=#{deptId} and sp.status=5
    <if test="typeId!=null and typeId!=''">
      and sp.type_id=#{typeId}
    </if>
    <if test="beginDate!=null and beginDate!='' and endDate!=null and endDate!=''">
      and sp.begin_time  BETWEEN #{beginDate}  AND  #{endDate}
    </if>) as count5 ,
  (select count(sp.sid) from supervision sp,user u where sp.manager_id=u.USER_ID AND u.DEPT_ID=#{deptId} and sp.status=6
    <if test="typeId!=null and typeId!=''">
      and sp.type_id=#{typeId}
    </if>
    <if test="beginDate!=null and beginDate!='' and endDate!=null and endDate!=''">
      and sp.begin_time  BETWEEN #{beginDate}  AND  #{endDate}
    </if>) as count6
</select>

  <select id="getSupApplyTaskList1" resultMap="UserResultMap" parameterType="com.xoa.model.supervision.Supervision" >
    SELECT
    sp.sid,
    sp.parent_id,
    sp.end_time,
    u_c.USER_NAME as creater_id,
    sp.leader_id,
    sp.manager_id as manager_id ,
    sp.sup_name,
    u_L.USER_NAME,
    u_m.USER_NAME as manager_Name,
    st.type_name,
    if (sp.manager_id=#{managerId},1,0) as count0 ,
    if ((sp.USER_ID LIKE concat('%,',#{userId},',%') OR sp.USER_ID LIKE concat(#{userId},',%')),1,0) as count1 ,
    if (sp.leader_id=#{managerId},1,0) as count2 ,
    sp.content,
    sp.status,
    sp.USER_ID
    FROM
    supervision_type st,
    supervision  sp LEFT JOIN 	`user` u_L  ON sp.leader_id=u_L.USER_ID
    left join  `user` u_m   ON sp.manager_id=u_m.USER_ID
    left join  `user` u_c  ON sp.creater_id=u_c.USER_ID
    WHERE st.sid=sp.type_id
    and  (sp.manager_id=#{managerId} or (sp.USER_ID LIKE concat('%,',#{userId},',%') OR sp.USER_ID LIKE concat(#{userId},',%')) or sp.leader_id=#{userId}) 
     and  
     <if test="status==1">
       sp.status in (1,2,4,5)
      </if>
      <if test="status!=1">
       sp.status=#{status}
     </if>
  </select>

  <update id="updateSup" parameterType="com.xoa.model.supervision.Supervision">
    update supervision
    <set >
      <if test="supName != null" >
        sup_name = #{supName,jdbcType=VARCHAR},
      </if>
      <if test="typeId != null" >
        type_id = #{typeId,jdbcType=INTEGER},
      </if>
      <if test="leaderId != null" >
        leader_id = #{leaderId,jdbcType=INTEGER},
      </if>
      <if test="managerId != null" >
        manager_id = #{managerId,jdbcType=INTEGER},
      </if>
      <if test="endTime != null" >
        end_time = #{endTime,jdbcType=TIMESTAMP},
      </if>
      <if test="beginTime != null" >
        begin_time = #{beginTime,jdbcType=TIMESTAMP},
      </if>
      <if test="content != null" >
        content = #{content,jdbcType=VARCHAR},
      </if>
      <if test="createrId != null" >
        creater_id = #{createrId,jdbcType=INTEGER},
      </if>
      <if test="createrTime != null" >
        creater_time = #{createrTime,jdbcType=TIMESTAMP},
      </if>
      <if test="status != null" >
        status = #{status,jdbcType=INTEGER},
      </if>
      <if test="parentId != null" >
        parent_id = #{parentId,jdbcType=INTEGER},
      </if>
      <if test="realEndTime != null" >
        real_end_time = #{realEndTime,jdbcType=TIMESTAMP},
      </if>
    </set>
    where sid = #{sid,jdbcType=INTEGER}
  </update>
  <select id="queryCountByType" parameterType="map" resultMap="UserResultMap">
 select 
 (select count(sid) from supervision LEFT JOIN user on supervision.manager_id=user.user_id  where type_id=#{typeId} and status=0
 <if test="beginDate != null">
      begin_time <![CDATA[>=]]>  beginDate
 </if>
 <if test="endDate != null">
      end_time  <![CDATA[<=]]>  endDate
 </if>
 <if test="deptId != null">
 user.DEPT_ID = #{deptId}
 </if>
 ) as count0 ,
 (select count(sid) from supervision LEFT JOIN user on supervision.manager_id=user.user_id   where type_id=#{typeId} and status=1
 <if test="beginDate != null">
      begin_time <![CDATA[>=]]>  beginDate
 </if>
 <if test="endDate != null">
      end_time  <![CDATA[<=]]>  endDate
 </if>
 <if test="deptId != null">
 user.DEPT_ID = #{deptId}
 </if>
 ) as count1 ,
 (select count(sid) from supervision LEFT JOIN user on supervision.manager_id=user.user_id   where type_id=#{typeId} and status=2
<if test="beginDate != null">
     and  begin_time <![CDATA[>=]]>  beginDate
 </if>
 <if test="endDate != null">
      and end_time  <![CDATA[<=]]>  endDate
 </if>
 <if test="deptId != null">
    and user.DEPT_ID = #{deptId}
 </if>
 ) as count2 ,
 (select count(sid) from supervision LEFT JOIN user on supervision.manager_id=user.user_id   where type_id=#{typeId} and status=3
 <if test="beginDate != null">
     and  begin_time <![CDATA[>=]]>  beginDate
 </if>
 <if test="endDate != null">
      and end_time  <![CDATA[<=]]>  endDate
 </if>
 <if test="deptId != null">
    and user.DEPT_ID = #{deptId}
 </if>
 ) as count3 ,
  (select count(sid) from supervision LEFT JOIN user on supervision.manager_id=user.user_id   where type_id=#{typeId} and status=4
  <if test="beginDate != null">
     and  begin_time <![CDATA[>=]]>  beginDate
 </if>
 <if test="endDate != null">
      and end_time  <![CDATA[<=]]>  endDate
 </if>
 <if test="deptId != null">
    and user.DEPT_ID = #{deptId}
 </if>
 ) as count4 ,
  (select count(sid) from supervision LEFT JOIN user on supervision.manager_id=user.user_id   where type_id=#{typeId} and status=5
<if test="beginDate != null">
     and  begin_time <![CDATA[>=]]>  beginDate
 </if>
 <if test="endDate != null">
      and end_time  <![CDATA[<=]]>  endDate
 </if>
 <if test="deptId != null">
    and user.DEPT_ID = #{deptId}
 </if>
  ) as count5 ,
  (select count(sid) from supervision LEFT JOIN user on supervision.manager_id=user.user_id   where type_id=#{typeId} and status=6
 <if test="beginDate != null">
     and  begin_time <![CDATA[>=]]>  beginDate
 </if>
 <if test="endDate != null">
      and end_time  <![CDATA[<=]]>  endDate
 </if>
 <if test="deptId != null">
    and user.DEPT_ID = #{deptId}
 </if>
  ) as count6
</select>

  <select id="queryCount" resultMap="UserResultMap" parameterType="map">
 select 
   (select count(sid) from supervision LEFT JOIN user on supervision.manager_id=user.user_id where status=0
    <if test="deptId != null">
      and user.DEPT_ID = #{deptId}
    </if>
    <if test="typeId!=null and typeId!=''">
      and type_id=#{typeId}
    </if>
    <if test="beginDate != null">
      and  begin_time <![CDATA[>=]]>  beginDate
    </if>
    <if test="endDate != null">
      and end_time  <![CDATA[<=]]>  endDate
    </if>
     ) as count0,
   (select count(sid) from supervision LEFT JOIN user on supervision.manager_id=user.user_id where status=7
    <if test="deptId != null">
      and user.DEPT_ID = #{deptId}
    </if>
    <if test="typeId!=null and typeId!=''">
      and type_id=#{typeId}
    </if>
    <if test="beginDate != null">
      and  begin_time <![CDATA[>=]]>  beginDate
    </if>
    <if test="endDate != null">
      and end_time  <![CDATA[<=]]>  endDate
    </if>
    ) as count1,
   (select count(sid) from supervision LEFT JOIN user on supervision.manager_id=user.user_id where status=1
    <if test="deptId != null">
      and user.DEPT_ID = #{deptId}
    </if>
    <if test="typeId!=null and typeId!=''">
      and type_id=#{typeId}
    </if>
    <if test="beginDate != null">
      and  begin_time <![CDATA[>=]]>  beginDate
    </if>
    <if test="endDate != null">
      and end_time  <![CDATA[<=]]>  endDate
    </if>
   ) as count2, 
   (select count(sid) from supervision LEFT JOIN user on supervision.manager_id=user.user_id where  real_end_time <![CDATA[>]]> end_time AND  status=1
    <if test="deptId != null">
      and user.DEPT_ID = #{deptId}
    </if>
    <if test="typeId!=null and typeId!=''">
      and type_id=#{typeId}
    </if>
    <if test="beginDate != null">
      and  begin_time <![CDATA[>=]]>  beginDate
    </if>
    <if test="endDate != null">
      and end_time  <![CDATA[<=]]>  endDate
    </if>
   ) as count3,
   (select count(sid) from supervision LEFT JOIN user on supervision.manager_id=user.user_id where status=3
    <if test="deptId != null">
      and user.DEPT_ID = #{deptId}
    </if>
    <if test="typeId!=null and typeId!=''">
      and type_id=#{typeId}
    </if>
    <if test="beginDate != null">
      and  begin_time <![CDATA[>=]]>  beginDate
    </if>
    <if test="endDate != null">
      and end_time  <![CDATA[<=]]>  endDate
    </if>
   ) as count4,
   (select count(sid) from supervision LEFT JOIN user on supervision.manager_id=user.user_id where real_end_time <![CDATA[>]]> end_time AND status=6
    <if test="deptId != null">
      and user.DEPT_ID = #{deptId}
    </if>
    <if test="typeId!=null and typeId!=''">
      and type_id=#{typeId}
    </if>
    <if test="beginDate != null">
      and  begin_time <![CDATA[>=]]>  beginDate
    </if>
    <if test="endDate != null">
      and end_time  <![CDATA[<=]]>  endDate
    </if>
    ) as count5 ,
   (select count(sid) from supervision LEFT JOIN user on supervision.manager_id=user.user_id where real_end_time <![CDATA[<=]]> end_time AND status=6
    <if test="deptId != null">
      and user.DEPT_ID = #{deptId}
    </if>
    <if test="typeId!=null and typeId!=''">
      and type_id=#{typeId}
    </if>
    <if test="beginDate != null">
      and  begin_time <![CDATA[>=]]>  beginDate
    </if>
    <if test="endDate != null">
      and end_time  <![CDATA[<=]]>  endDate
    </if>
   ) as count6
</select>

  <update id="updateSupervision" parameterType="com.xoa.model.supervision.Supervision">
    update supervision
    <set >
      <if test="supName != null" >
        sup_name = #{supName},
      </if>
      <if test="typeId != null" >
        type_id = #{typeId},
      </if>
      <if test="leaderId != null" >
        leader_id = #{leaderId},
      </if>
      <if test="managerId != null" >
        manager_id = #{managerId},
      </if>
      <if test="endTime != null" >
        end_time = #{endTime},
      </if>
      <if test="beginTime != null" >
        begin_time = #{beginTime},
      </if>
      <if test="content != null" >
        content = #{content},
      </if>
      <if test="createrId != null" >
        creater_id = #{createrId},
      </if>
      <if test="createrTime != null" >
        creater_time = #{createrTime},
      </if>
      <if test="status != null" >
        status = #{status},
      </if>
      <if test="parentId != null" >
        parent_id = #{parentId},
      </if>
      <if test="realEndTime != null" >
        real_end_time = #{realEndTime},
      </if>
      <if test="status != null" >
        status = #{status},
      </if>
    </set>
    where sid = #{sid}
  </update>
</mapper>